#!/bin/bash
#needed if run as cronjob
export XDG_VIDEOS_DIR=$HOME/vids
DLARCHIVE=$XDG_VIDEOS_DIR/.downloaded
DLLOC=$XDG_VIDEOS_DIR
CHANNELSFILE=$XDG_VIDEOS_DIR/.channels
BLACKLIST=$XDG_VIDEOS_DIR/.blacklist

# Required to display notifications if run as a cronjob:
export DBUS_SESSION_BUS_ADDRESS=unix:path=/run/user/$(id -u)/bus
export DISPLAY=:0.0

APIKEY="$(pass show Misc/Youtube\ Data\ API\ v3 | head -n1 )"

if [ $(pgrep -c ripper) -gt 1 ]; then
	echo "Ripper already running, exiting new instance..."
	exit
fi

echo "Scanning for new Videos to download"
echo "Scanning on Youtube:"
IDs="$( grep 'youtube' "$CHANNELSFILE" | grep -v '^#' | grep 'channel' | sed 's/https:\/\/www\.youtube\.com\/channel\///')"
not_correctly_formatted="$(grep 'youtube' "$CHANNELSFILE" | grep -v '^#' | grep -v 'channel')"
if [  "$( echo "$not_correctly_formatted" | wc -l )" -gt 0 ]; then
	echo Please fix the following channel urls to be scannable:
	echo "$not_correctly_formatted"
	echo "They need to be in the 'https://www.youtube.com/channel/...' format"
fi
for channel_id in $IDs; do
	echo "ID: $channel_id"
	curl -s "https://www.googleapis.com/youtube/v3/search?key=$APIKEY&channelId=$channel_id&part=snippet,id&order=date&maxResults=500" | jq '."items" | .[] | .id."videoId"' | tr -d '"' | sed 's/^/https:\/\/www\.youtube\.com\/watch\?v=/' | grep -vf "$BLACKLIST" >> /tmp/todownload$$
done
grep 'youtube' "$DLARCHIVE" | sed 's/youtube /https:\/\/www\.youtube\.com\/watch?v=/' > /tmp/alreadydownloaded$$

echo "Scanning on Bitchute..."
grep 'bitchute' "$CHANNELSFILE" | grep -v '^#' | xargs -L1 lynx --dump --nonumbers -listonly | grep 'bitchute\.com\/video' | sort -u | grep -vf "$BLACKLIST" >> /tmp/todownload$$
grep 'bitchute' "$DLARCHIVE" | sed 's/bitchute /https:\/\/www\.bitchute\.com\/video\//' >> /tmp/alreadydownloaded$$

grep -vf /tmp/alreadydownloaded$$ /tmp/todownload$$ | sort -u > /tmp/new_videos$$
number=$(wc -l /tmp/new_videos$$ | cut -d ' ' -f 1 )
if [ $number -gt 0 ]; then
	[ $number -gt 1 ] && plural="s"
	notify-send "Channel Ripper" "$number new video$plural available for download, downloading now."
	echo  "$number new video$plural for download available, downloading now."
	if [ "$number"  -lt 10 ];then
		youtube-dl --get-filename -o "'%(uploader)s' '%(title)s'" -a /tmp/new_videos$$ | xargs -L1 notify-send
	fi
	rm -f /tmp/alreadydownloaded$$ /tmp/todownload$$
	youtube-dl --hls-prefer-native -i --download-archive $DLARCHIVE -f 'bestvideo[ext=mp4]+bestaudio[ext=m4a]/best[ext=mp4]/best' --add-metadata -o "$DLLOC/%(uploader)s/%(upload_date)s-%(title)s.%(ext)s" -a /tmp/new_videos$$
	rm -f /tmp/new_videos$$
	notify-send "Channel Ripper" "Finished downloading"
fi

if [ $number -eq 0 ]; then
	echo "No new videos"
fi
rm -f /tmp/alreadydownloaded$$ /tmp/todownload$$
